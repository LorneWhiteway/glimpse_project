# glimpse_project

## Introduction

This repository contains code to allow [glimpse](https://github.com/CosmoStat/Glimpse) (a mass-mapping algorithm that works on patches of the sky that are assumed to be small and flat) to be run on a larger patch (such as the DES footprint).

The code does this in three steps:
a. *create_cutouts*: an input weak-lensing catalogue is subdivided into many smaller overlapping sub-catalogues (call each one a 'cutout');
b. *run_glimpse*: glimpse is run (possibly in parallel) on each cutout;
c. *merge*: the separate glimpse results are merged together to create an output convergence map (in Healpix format).

The code is structured so that other mass-mapping algorithms can be handled in the future.

## Interface

The primary interface is the Python script `glimpse_on_curved_sky.py` in the `./scripts` directory. Run this with command line arguments as follows:

| Option | Meaning |
| --- | --- |
| -i | Name of configuration file. See below for details of configuration file format. Required. |
| -t | Task. One of "create_cutouts", "run_glimpse" or "merge". Required. |
| -j | Job control. See below for more information. Optional; see below for default behavious if not provided. |

Example:
```
./scripts/glimpse_on_curved_sky.py -i ./output/my_job.ini -t create_cutouts
```

### Configuration file

The configuration file should be in [standard INI file format](https://en.wikipedia.org/wiki/INI_file). We describe the various sections that should be provided.

#### Section [project]

| Key | Value |
| --- | --- |
| glimpse_executable | Path to glimpse executable e.g. /home/Glimpse/glimpse. Required. |

#### Section [create_cutouts]

Cutout catalogues will be generated by extracting data from *input_catalogue*; use *ra_name*, *dec_name*, *shear_names* and *other_field_names* to specify which columns will be copied from the input catalogue to the cutouts.

Each cutout will be centered on a point that is the centre of a Healpixel. Use *nside* to set the NSIDE for healpixelisation that sets these centres. each cutout will be a square, of side length *cutout_side_in_degrees*, but rotated 45 degrees with respect to the RA/DEC axes.


| Key | Value |
| --- | --- |
| input_catalogue | The full name of the source weak-lensing catalogue (FITS format). Required. |
| ra_name | Catalogue field name for right ascension (assumed to be in decimal degrees between 0 and 360). Optional; default is "RA". |
| dec_name | Catalogue field name for declination (assumed to be in decimal degrees between -90 and 90). Optional; default is "DEC". |
| shear_names | Comma-delimited list of catalogue field names for weak-lensing shear values to be written to the cutouts. Provide one or more pairs of field names. Required. Example: "E1,E2"|
| other_field_names | Comma-delimited list of catalogue field names for other fields (such as redshift) to be written to the cutouts. Required. |
| nside | The cutouts will be centred on the centres of Healpix pixels with this value as NSIDE. Optional; default is 16. |
| cutout_side_in_degrees | The side length of each cutout, in degrees. Optional; default is 16. |

#### Section [merge]

| Key | Value |
| --- | --- |
| outer_border | 90 |
| inner_border | 110 |
| intermediate_nside | 2048 |
| output_nside | 1024 |
| apply_galaxy_mask? | True |

#### Section [survey]

This section is used by Glimpse; in the fture you will be able to refer to glimpse documentation for details.

#### Section [cosmology]

This section is used by Glimpse; in the fture you will be able to refer to glimpse documentation for details.

#### Section [field]

This section is used by Glimpse; in the fture you will be able to refer to glimpse documentation for details.

#### Section [parameters]

This section is used by Glimpse; in the fture you will be able to refer to glimpse documentation for details.



### Job Control

(TO DO)

## Information useful for running glimpse on the splinter cluster at UCL.

### To build Glimpse in the splinter environment

1. git clone https://github.com/LorneWhiteway/glimpse_project.git
2. cd ./glimpse_project
3. source ./set_environment
4. git clone https://github.com/CosmoStat/Glimpse.git
5. Edit ./Glimpse/src/field.cpp to fix a bug: Find the line 
lensKernel[ind] = 1. ;
and in the same for loop also add the line
lensKernelTrue[ind] = 1. ;
6. cd ./Glimpse
7. ../cm.sh (This will run cmake with the correct settings)
8. cd ./build
9. make

### Things to know about glimpse:
1. Command line arguments should be ini file, input catalogue, and output file name (in that order), The flags '--config', '--data' and '--output' should not be provided.
2. In the ini file, the 'size' argument is the length of the edge of a square. 