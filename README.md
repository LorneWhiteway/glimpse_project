# glimpse_project

## Introduction

This repository contains code to allow [glimpse](https://github.com/CosmoStat/Glimpse) (a mass-mapping algorithm that works on patches of the sky that are assumed to be small and flat) to be run on a larger patch (such as the DES footprint).

The code does this in three steps:
1. *create_cutouts*: an input weak-lensing catalogue is subdivided into many smaller overlapping sub-catalogues (call each one a 'cutout');
2. *run_glimpse*: glimpse is run (possibly in parallel) on each cutout;
3. *merge*: the separate glimpse results are merged together to create an output convergence map (in healpix format).

The code is structured so that other mass-mapping algorithms besides glimpse can be handled in the future.

## Interface

The primary interface is the Python script `glimpse_on_curved_sky.py` in the `./scripts` directory. Run this with command line arguments as follows:

| Option | Meaning |
| --- | --- |
| -i | Name of configuration file. See below for details of configuration file format. Required. |
| -t | Task. One of "create_cutouts", "run_glimpse" or "merge". Required. |
| -j | Job control. See below for more information. Optional; see below for default behaviour if not provided. |

Example:
```
./scripts/glimpse_on_curved_sky.py -i ./output/my_job.ini -t create_cutouts
```

### Configuration file

The configuration file should be in [standard INI file format](https://en.wikipedia.org/wiki/INI_file). Below we describe the various sections that should be provided.

#### Section [project]

| Key | Value |
| --- | --- |
| glimpse_executable | Path to glimpse executable e.g. /home/Glimpse/glimpse. Required. |

#### Section [create_cutouts]

The *input_catalogue* should be a weak-lensing catalogue. It should be in FITS format, and have (at least) data for RA (decimal degrees [0,360]), DEC (decimal degrees [-90,90]), two shear components, and redshift. Note that redshift is required but is not actually used; if *input_catalogue* does not have redshifts then augment this catalogue by appending a redshift field with dummy values.

Cutout catalogues are FITS files generated by extracting data from *input_catalogue*; use *ra_name*, *dec_name*, *shear_names* and *other_field_names* to specify which columns will be copied from the input catalogue to the cutouts. The field names in the cutout catalogues will be the same as the field names in the input catalogue (i.e. we do not standardise field names).

Each cutout catalogue *c* will contain data on galaxies that are in a diamond-shaped region on the celestial sphere that:
1. is centered on a point that is the centre of a healpixel *h*. Use *nside* to specify the NSIDE for the healpixelisation that sets these centres. The cutout *c* will be assigned an id that is the healpixel id (in RING orientation) of *h*.
2. has side length *cutout_side_in_degrees*;
3. is rotated 45 degrees with respect to the RA/DEC axes.

Once these galaxies have been selected, all the data is then:
1. translated to be centred at the standard centre (RA=180, DEC=0). (We use a standard centre so that we do not need separate glimpse ini files for each cutout; this particular standard centre was chosen as it is well away from the RA=0 line which glimpse does not handle well (due to the discontinuity in RA));
2. rotated (TODO: which direction?) by 45 degrees (so that its sides are parallel to the RA/DEC coordinate axes). Shear values are transformed appropriately. (This rotation is done because our use of healpix to generate cutout centres leads to a preference for diamond-shaped regions, while glimpse prefers a square input region).

If *c* contains no galaxies then no corresponding file will be created.

| Key | Value |
| --- | --- |
| input_catalogue | The full name of the source weak-lensing catalogue (FITS format). Required. |
| ra_name | Catalogue field name for right ascension. The values in this field will be written to the cutout files. Optional; default is "RA". |
| dec_name | Catalogue field name for declination. The values in this field will be written to the cutout files. Optional; default is "DEC". |
| shear_names | Comma-delimited list of catalogue field names for weak-lensing shear values to be written to the cutouts. Provide one or more pairs of field names. Required. Example: "E1,E2"|
| other_field_names | Comma-delimited list of catalogue field names for other fields (such as redshift) to be written to the cutouts. Required. |
| nside | The cutouts will be centred on the centres of healpixels with this value as NSIDE. Optional; default is 16. |
| cutout_side_in_degrees | The side length of each cutout, in degrees. Optional; default is 16. |

#### Section [merge]

Each glimpse output file contains convergence (kappa) values on an array of points (an evenly-spaced square array of points in the tangent plane (i.e. tangent at the centre of the glimpse input region) which are then projected back down to the celestial sphere using an [orthographic](https://en.wikipedia.org/wiki/Orthographic_projection_in_cartography) projection).

Merging begins by translating each output array of points from the standard centre back to the appropriate healpix centre, and undoing the 45 degree rotation. For each point *q* in a given array we assign a weight *w(q)* as follows:
1. if the distance from *q* to the edge (in units given by the array spacing; by 'edge' we mean the outermost set of array points) is less than *outer_border* then *w(q)* is zero;
2. if this distance is greater than or equal to *inner_border* then *w(q)* is one;
3. otherwise *w(q)* varies smoothly between these two extremes.

We then create a fine healpixelisation with NSIDE *intermediate_nside*. For each pixel *p* in this healpixelisation and each output glimpse array *a* we find the point *q(a,p)* in *a* that is closest to the centre of *p* (together with its associated weight *w(a,p)*). The pixel *p* is then assigned a kappa value that is the weighted average of the glimpse kappa values at the points *q(a,p)* (as *a* ranges across all glimpse output files), using as weights the *w(a,p)*. Note that since the weights are zero on the edge of *a*, arrays that are distant from *p* will not contribute to the weighted average (as expected). This gives us a healpix map of weighted average kappa values (we also create a healpix map of weights).

Two final post-processing steps are performed:
1. The value and weight maps are downsampled to NSIDE *output_nside*;
2. If desired (via *apply_galaxy_mask?*) the downsampled value map (but not the weight map) is masked by setting to zero the kappa value in any healpixel in which no source galaxies were found.

| Key | Value |
| --- | --- |
| outer_border | Used to specify weights to be assigned to glimpse array points; see above for details. Must be positive. Typical value is 90. Required. |
| inner_border | Used to specify weights to be assigned to glimpse array points; see above for details. Cannot be less than inner_border. Typical value is 110. Required. |
| intermediate_nside | NSIDE of intermediate (fine) healpixelisation when merging; see above for details. Typical value is 2048. Required. |
| output_nside | NSIDE of healpixelisation used in final output map. Typical value is 1024. (Fun fact: on Earth an NSIDE of 1024 would give pixels about two-thirds the size of Manhattan). Required. |
| apply_galaxy_mask? | If True, then mask the output map by setting kappa values to zero for pixels containing no source galaxies. Required. |

#### Section [survey]

This section is used by Glimpse; in the future perhaps you will be able to refer to glimpse documentation for details.

#### Section [cosmology]

This section is used by Glimpse; in the future perhaps you will be able to refer to glimpse documentation for details.

#### Section [field]

This section is used by Glimpse; in the future perhaps you will be able to refer to glimpse documentation for details.

#### Section [parameters]

This section is used by Glimpse; in the future perhaps you will be able to refer to glimpse documentation for details.

### Job Control

Use this command line parameter to subselect only some data for processing.

1. When creating cutouts and when merging, use this to specify that only a subset of all possible cutouts should be handled - this is useful primarily during testing. Use Python slice notation, so that for example `[2000:2100]` would handle only cutouts with 2000 <= id < 2100, while `[::2]` would handle all even-numbered cutouts. Note that ids are zero-based. For cutout creation and merging, job_control is optional; if omitted then all possible cutouts will be handled.
2. When running glimpse, use this to specify the id of which single cutout is to be processed. Note that ids are zero-based. Required.

## File names

1. At run time the user specifies an ini file. All intermediate and output files are created in the same directory as the ini file (so it makes sense to give this directory a name reflecting its purpose).
2. The ini file can have any name (but glimpse.ini is traditional).
3. Cutout catalogues will have names `{id}.cat.fits` where `{id}` is the id of the cutout (= healpix id of central point).
4. Output files from glimpse will have names `{id}.glimpse.out.fits`.
5. Final output value and weight files will be called `glimpse.merged.values.dat` and `glimpse.merged.weights.dat` respectively.


## Information useful for running glimpse on the splinter cluster at UCL.

### To build Glimpse in the splinter environment

1. git clone https://github.com/LorneWhiteway/glimpse_project.git
2. cd ./glimpse_project
3. source ./set_environment
4. git clone https://github.com/CosmoStat/Glimpse.git
5. Edit ./Glimpse/src/field.cpp to fix a bug: Find the line 
	`lensKernel[ind] = 1. ;`
and in the same `for` loop also add the line
	`lensKernelTrue[ind] = 1. ;`
6. cd ./Glimpse
7. ../cm.sh (This will run cmake with the correct settings)
8. cd ./build
9. make

### Things to know about glimpse:
1. Command line arguments should be ini file, input catalogue, and output file name (in that order), The input item specifiers '--config', '--data' and '--output' should not be provided (despite what the function help says).
2. In the ini file, the 'size' argument is the length of the edge of a square. 
